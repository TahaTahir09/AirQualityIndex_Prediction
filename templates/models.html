{% extends "base.html" %}

{% block title %}Model Analytics - AQI Prediction System{% endblock %}

{% block extra_styles %}
<style>
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }

    .stat-card {
        background: white;
        border-radius: 16px;
        padding: 25px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.05);
        border: 1px solid #e2e8f0;
        transition: all 0.3s ease;
    }

    .stat-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 12px 24px rgba(0,0,0,0.1);
    }

    .stat-header {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 15px;
    }

    .stat-icon {
        width: 50px;
        height: 50px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        color: white;
    }

    .stat-label {
        font-size: 0.875rem;
        color: #64748b;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .stat-value {
        font-size: 2.5rem;
        font-weight: 800;
        color: var(--dark);
        margin-top: 10px;
    }

    .stat-trend {
        display: inline-flex;
        align-items: center;
        gap: 5px;
        margin-top: 10px;
        padding: 5px 12px;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 600;
    }

    .trend-up {
        background: #ecfdf5;
        color: #059669;
    }

    .trend-down {
        background: #fef2f2;
        color: #dc2626;
    }

    /* Model Cards */
    .models-container {
        margin-top: 30px;
    }

    .models-grid {
        display: grid;
        gap: 25px;
    }

    .model-card {
        background: white;
        border-radius: 16px;
        padding: 30px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.05);
        border: 1px solid #e2e8f0;
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
    }

    .model-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 5px;
        height: 100%;
        background: linear-gradient(180deg, var(--primary) 0%, var(--secondary) 100%);
    }

    .model-card:hover {
        box-shadow: 0 12px 24px rgba(0,0,0,0.1);
        transform: translateX(5px);
    }

    .model-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 25px;
    }

    .model-title {
        display: flex;
        align-items: center;
        gap: 15px;
    }

    .model-icon {
        width: 60px;
        height: 60px;
        border-radius: 14px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.8rem;
        color: white;
        background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
    }

    .model-info h3 {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--dark);
        margin-bottom: 5px;
    }

    .model-type {
        font-size: 0.85rem;
        color: #64748b;
        font-weight: 500;
    }

    .model-badge {
        padding: 8px 16px;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .badge-best {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        color: white;
    }

    .badge-good {
        background: #dbeafe;
        color: #1e40af;
    }

    .metrics-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 20px;
        margin-bottom: 20px;
    }

    .metric-item {
        background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
        padding: 20px;
        border-radius: 12px;
        border: 1px solid #e2e8f0;
        text-align: center;
    }

    .metric-label {
        font-size: 0.8rem;
        color: #64748b;
        font-weight: 600;
        margin-bottom: 8px;
        text-transform: uppercase;
    }

    .metric-value {
        font-size: 1.8rem;
        font-weight: 700;
        color: var(--dark);
    }

    .metric-unit {
        font-size: 0.9rem;
        color: #94a3b8;
        font-weight: 500;
    }

    .model-description {
        margin-top: 20px;
        padding: 20px;
        background: #f8fafc;
        border-radius: 12px;
        border-left: 4px solid var(--primary);
    }

    .model-description h4 {
        font-size: 0.95rem;
        font-weight: 600;
        color: var(--dark);
        margin-bottom: 10px;
    }

    .model-description p {
        font-size: 0.9rem;
        color: #64748b;
        line-height: 1.6;
    }

    /* Comparison Chart */
    .comparison-section {
        background: white;
        border-radius: 16px;
        padding: 30px;
        margin-top: 30px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.05);
        border: 1px solid #e2e8f0;
    }

    .section-header {
        display: flex;
        align-items: center;
        gap: 15px;
        margin-bottom: 25px;
    }

    .section-icon {
        width: 50px;
        height: 50px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        color: white;
        background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
    }

    .section-title {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--dark);
    }

    .chart-wrapper {
        position: relative;
        height: 400px;
        margin-top: 20px;
    }

    /* No Data State */
    .no-data {
        text-align: center;
        padding: 60px 20px;
        color: #94a3b8;
    }

    .no-data i {
        font-size: 4rem;
        margin-bottom: 20px;
        opacity: 0.5;
    }

    .no-data h3 {
        font-size: 1.5rem;
        font-weight: 600;
        margin-bottom: 10px;
    }

    .no-data p {
        font-size: 1rem;
    }

    @keyframes slideInLeft {
        from {
            opacity: 0;
            transform: translateX(-30px);
        }
        to {
            opacity: 1;
            transform: translateX(0);
        }
    }

    .slide-in-left {
        animation: slideInLeft 0.6s ease;
    }
</style>
{% endblock %}

{% block page_title %}Model Analytics{% endblock %}
{% block page_subtitle %}Performance metrics and comparisons{% endblock %}

{% block content %}
<!-- Summary Stats -->
<div class="stats-grid">
    <div class="stat-card slide-in-up">
        <div class="stat-header">
            <div class="stat-icon" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
                <i class="fas fa-brain"></i>
            </div>
        </div>
        <div class="stat-label">Total Models</div>
        <div class="stat-value" id="totalModels">5</div>
        <div class="stat-trend trend-up">
            <i class="fas fa-arrow-up"></i>
            <span>Active</span>
        </div>
    </div>

    <div class="stat-card slide-in-up" style="animation-delay: 0.1s;">
        <div class="stat-header">
            <div class="stat-icon" style="background: linear-gradient(135deg, #f59e0b 0%, #f97316 100%);">
                <i class="fas fa-trophy"></i>
            </div>
        </div>
        <div class="stat-label">Best R² Score</div>
        <div class="stat-value" id="bestR2">0.948</div>
        <div class="stat-trend trend-up">
            <i class="fas fa-arrow-up"></i>
            <span>Excellent</span>
        </div>
    </div>

    <div class="stat-card slide-in-up" style="animation-delay: 0.2s;">
        <div class="stat-header">
            <div class="stat-icon" style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);">
                <i class="fas fa-chart-line"></i>
            </div>
        </div>
        <div class="stat-label">Lowest RMSE</div>
        <div class="stat-value" id="lowestRMSE">9.17</div>
        <div class="stat-trend trend-down">
            <i class="fas fa-arrow-down"></i>
            <span>Better</span>
        </div>
    </div>

    <div class="stat-card slide-in-up" style="animation-delay: 0.3s;">
        <div class="stat-header">
            <div class="stat-icon" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                <i class="fas fa-clock"></i>
            </div>
        </div>
        <div class="stat-label">Last Training</div>
        <div class="stat-value" style="font-size: 1.5rem;" id="lastTraining">Today</div>
        <div class="stat-trend" style="background: #f3f4f6; color: #64748b;">
            <i class="fas fa-calendar"></i>
            <span id="trainingDate">Recent</span>
        </div>
    </div>
</div>

<!-- Model Cards -->
<div class="models-container">
    <div class="models-grid" id="modelsGrid">
        <!-- Models will be loaded here -->
    </div>
</div>

<!-- Comparison Charts -->
<div class="comparison-section slide-in-up" style="animation-delay: 0.5s;">
    <div class="section-header">
        <div class="section-icon">
            <i class="fas fa-chart-bar"></i>
        </div>
        <div>
            <div class="section-title">Model Performance Comparison</div>
            <p style="color: #64748b; font-size: 0.9rem; margin-top: 5px;">Compare metrics across all models</p>
        </div>
    </div>
    <div class="chart-wrapper">
        <canvas id="comparisonChart"></canvas>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    const modelDescriptions = {
        'LinearRegression': 'A simple and interpretable baseline model using linear relationships between features and AQI.',
        'RandomForest': 'An ensemble learning method using multiple decision trees with Optuna hyperparameter optimization.',
        'XGBoost': 'Gradient boosting algorithm with advanced regularization and Optuna optimization for superior performance.',
        'LSTM': 'Deep learning recurrent neural network capable of learning temporal patterns in sequential AQI data.',
        'CNN': 'Convolutional neural network for extracting spatial features and patterns from time-series data.',
        'CNN_1D': 'Convolutional neural network for extracting spatial features and patterns from time-series data.'
    };

    const modelTypes = {
        'LinearRegression': 'Classical Machine Learning',
        'RandomForest': 'Ensemble Learning',
        'XGBoost': 'Gradient Boosting',
        'LSTM': 'Deep Learning - RNN',
        'CNN': 'Deep Learning - CNN',
        'CNN_1D': 'Deep Learning - CNN'
    };

    let comparisonChart;

    async function loadModelStats() {
        try {
            const response = await fetch('/api/models/stats');
            const data = await response.json();

            if (data.error) {
                showNoData();
                return;
            }

            displayModelCards(data.models);
            displayComparisonChart(data.models);
            updateSummaryStats(data.models, data.best_model, data.timestamp);
        } catch (error) {
            console.error('Error loading model stats:', error);
            showNoData();
        }
    }

    function displayModelCards(models) {
        const container = document.getElementById('modelsGrid');
        
        if (!models || models.length === 0) {
            showNoData();
            return;
        }

        // Sort by R² score descending
        const sortedModels = [...models].sort((a, b) => b.r2 - a.r2);
        const bestR2 = sortedModels[0].r2;

        container.innerHTML = sortedModels.map((model, index) => {
            const isBest = model.r2 === bestR2;
            const gradients = [
                'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)',
                'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)',
                'linear-gradient(135deg, #43e97b 0%, #38f9d7 100%)',
                'linear-gradient(135deg, #fa709a 0%, #fee140 100%)'
            ];

            return `
                <div class="model-card slide-in-left" style="animation-delay: ${index * 0.1}s;">
                    <div class="model-header">
                        <div class="model-title">
                            <div class="model-icon" style="background: ${gradients[index % gradients.length]};">
                                <i class="fas fa-${getModelIcon(model.name)}"></i>
                            </div>
                            <div class="model-info">
                                <h3>${model.name}</h3>
                                <p class="model-type">${modelTypes[model.name] || 'Machine Learning'}</p>
                            </div>
                        </div>
                        ${isBest ? '<div class="model-badge badge-best"><i class="fas fa-crown"></i> Best Model</div>' : '<div class="model-badge badge-good">Active</div>'}
                    </div>

                    <div class="metrics-grid">
                        <div class="metric-item">
                            <div class="metric-label">R² Score</div>
                            <div class="metric-value">${model.r2.toFixed(4)}</div>
                        </div>
                        <div class="metric-item">
                            <div class="metric-label">RMSE</div>
                            <div class="metric-value">${model.rmse.toFixed(2)}<span class="metric-unit">AQI</span></div>
                        </div>
                        <div class="metric-item">
                            <div class="metric-label">MAE</div>
                            <div class="metric-value">${model.mae.toFixed(2)}<span class="metric-unit">AQI</span></div>
                        </div>
                        <div class="metric-item">
                            <div class="metric-label">Performance</div>
                            <div class="metric-value" style="font-size: 1.2rem;">${model.performance || 'N/A'}</div>
                        </div>
                    </div>

                    <div class="model-description">
                        <h4><i class="fas fa-info-circle"></i> Description</h4>
                        <p>${modelDescriptions[model.name] || 'Machine learning model for AQI prediction.'}</p>
                    </div>
                </div>
            `;
        }).join('');
    }

    function displayComparisonChart(models) {
        const ctx = document.getElementById('comparisonChart').getContext('2d');
        
        if (comparisonChart) {
            comparisonChart.destroy();
        }

        const labels = models.map(m => m.name);
        
        comparisonChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: 'R² Score',
                        data: models.map(m => m.r2),
                        backgroundColor: 'rgba(102, 126, 234, 0.8)',
                        borderColor: '#667eea',
                        borderWidth: 2,
                        borderRadius: 8
                    },
                    {
                        label: 'RMSE (÷10)',
                        data: models.map(m => m.rmse / 10),
                        backgroundColor: 'rgba(245, 158, 11, 0.8)',
                        borderColor: '#f59e0b',
                        borderWidth: 2,
                        borderRadius: 8
                    },
                    {
                        label: 'MAE (÷10)',
                        data: models.map(m => m.mae / 10),
                        backgroundColor: 'rgba(59, 130, 246, 0.8)',
                        borderColor: '#3b82f6',
                        borderWidth: 2,
                        borderRadius: 8
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'top',
                        labels: {
                            font: { size: 13, weight: '500' },
                            padding: 15,
                            usePointStyle: true
                        }
                    },
                    tooltip: {
                        backgroundColor: 'rgba(0,0,0,0.8)',
                        padding: 12,
                        titleFont: { size: 14, weight: '600' },
                        bodyFont: { size: 13 }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: {
                            color: 'rgba(0,0,0,0.05)'
                        },
                        ticks: {
                            font: { size: 12 }
                        }
                    },
                    x: {
                        grid: {
                            display: false
                        },
                        ticks: {
                            font: { size: 12, weight: '500' }
                        }
                    }
                }
            }
        });
    }

    function updateSummaryStats(models, bestModel, timestamp) {
        const topModel = models.reduce((best, current) => 
            current.r2 > best.r2 ? current : best
        );
        const lowestRMSE = Math.min(...models.map(m => m.rmse));

        document.getElementById('totalModels').textContent = models.length;
        document.getElementById('bestR2').textContent = topModel.r2.toFixed(3);
        document.getElementById('lowestRMSE').textContent = lowestRMSE.toFixed(2);
        
        // Update training date
        if (timestamp) {
            const date = new Date(timestamp);
            const today = new Date();
            const isToday = date.toDateString() === today.toDateString();
            
            if (isToday) {
                document.getElementById('lastTraining').textContent = 'Today';
                document.getElementById('trainingDate').textContent = date.toLocaleTimeString('en-US', { 
                    hour: '2-digit', 
                    minute: '2-digit' 
                });
            } else {
                document.getElementById('lastTraining').textContent = date.toLocaleDateString('en-US', { 
                    month: 'short', 
                    day: 'numeric' 
                });
                document.getElementById('trainingDate').textContent = date.toLocaleDateString('en-US');
            }
        }
    }

    function getModelIcon(modelName) {
        const icons = {
            'LinearRegression': 'chart-line',
            'RandomForest': 'tree',
            'XGBoost': 'rocket',
            'LSTM': 'project-diagram',
            'CNN': 'network-wired',
            'CNN_1D': 'network-wired'
        };
        return icons[modelName] || 'brain';
    }

    function showNoData() {
        document.getElementById('modelsGrid').innerHTML = `
            <div class="no-data">
                <i class="fas fa-database"></i>
                <h3>No Model Data Available</h3>
                <p>Train models using train_model.py to see statistics here</p>
            </div>
        `;
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', loadModelStats);
</script>
{% endblock %}
